//
// fréquence = pas / s
// 1 tour = 200 pas
// 1 tour = ratio * Pi * diametre_roue
// vitesse = cm/s = 1 tour / 1600 pas * fréquence

//
// diametre_roue = 10 cm
// ratio = 3
// 1 tour = 94,25 cm
// si on veut 50 cm/s, il faut 1/2 tour par seconde = 200 impulsions par seconde


//----- Include Files ---------------------------------------------------------
#include <avr/io.h>		// include I/O definitions (port names, pin names, etc)
#include <avr/interrupt.h>	// include interrupt support
#include <math.h>

#include "global.h"		// include our global settings
#include "timer.h"		// include timer function library (timing, PWM, etc)
#include "pulse.h"		// include pulse function library



u16 freq[255] = {41.79,66.83,85.81,101.54,115.16,127.30,138.31,148.45,157.87,166.69,175.00,182.88,190.38,197.53,204.39,210.97,217.31,223.43,229.34,235.07,240.62,246.01,251.25,256.35,261.32,266.16,270.89,275.52,280.03,284.45,288.78,293.02,297.17,301.25,305.24,309.17,313.02,316.81,320.53,324.19,327.79,331.33,334.82,338.25,341.63,344.97,348.25,351.49,354.68,357.83,360.94,364.00,367.03,370.02,372.97,375.88,378.76,381.60,384.41,387.18,389.93,392.64,395.32,397.98,400.60,403.20,405.77,408.31,410.82,413.31,415.77,418.21,420.63,423.02,425.39,427.74,430.06,432.36,434.64,436.90,439.14,441.36,443.56,445.74,447.90,450.04,452.16,454.27,456.36,458.43,460.48,462.52,464.54,466.54,468.53,470.50,472.46,474.40,476.33,478.24,480.14,482.02,483.89,485.75,487.59,489.42,491.23,493.03,494.82,496.60,498.36,500.11,501.85,503.58,505.30,507.00,508.69,510.37,512.04,513.70,515.35,516.99,518.61,520.23,521.83,523.43,525.01,526.59,528.15,529.71,531.26,532.79,534.32,535.84,537.34,538.84,540.33,541.82,543.29,544.75,546.21,547.65,549.09,550.52,551.94,553.36,554.76,556.16,557.55,558.93,560.31,561.68,563.04,564.39,565.73,567.07,568.40,569.72,571.04,572.35,573.65,574.94,576.23,577.51,578.79,580.06,581.32,582.57,583.82,585.06,586.30,587.53,588.75,589.97,591.18,592.38,593.58,594.78,595.96,597.15,598.32,599.49,600.66,601.81,602.97,604.11,605.26,606.39,607.52,608.65,609.77,610.89,612.00,613.10,614.20,615.30,616.39,617.47,618.55,619.63,620.70,621.76,622.82,623.88,624.93,625.97,627.02,628.05,629.09,630.11,631.14,632.16,633.17,634.18,635.19,636.19,637.18,638.18,639.17,640.15,641.13,642.11,643.08,644.05,645.01,645.97,646.92,647.88,648.82,649.77,650.71,651.64,652.58,653.50,654.43,655.35,656.27,657.18,658.09,658.99,659.90,660.80,661.69,662.58,663.47,664.35,665.24,666.11,666.99,667.86,668.73,669.59,670.45,671.31,672.16};

//----- Begin Code ------------------------------------------------------------
int main(void)
{
	u08 j;
	u16 i;
	
	// initialize the timer system
	timerInit();
	
	// set pulse pins as output
	// ** these are the correct pins for most processors, but not all **
	sbi(DDRB, 1);
	sbi(DDRB, 2); // OAC1A
	
	
	pulseInit();
	pulseT1Init();
		
	// sortie
	DDRB = 0xFF;
	cbi(PORTB,0);	// DIR G
	cbi(PORTB,4);	// ENA G
	cbi(PORTB,3);	// DIR D
	cbi(PORTB,5);	// ENA D
		
	// pulse
	
	sbi(PORTB,4);
	sbi(PORTB,5);
		
	for (j=0; j<5; j++) {
	
	for (i=0; i< 255; i++) {	
		pulseT1ASetFreq(freq[i]);
		pulseT1ARun(1);
		while (pulseT1ARemaining());
		
	}
	
	pulseT1ASetFreq(freq[254]);
	pulseT1ARun(300);
	while (pulseT1ARemaining());
	
	for (i=0; i< 255; i++) {	
		pulseT1ASetFreq(freq[254-i]);
		pulseT1ARun(1);
		while (pulseT1ARemaining());
		
	}
	
	}

	cbi(PORTB,4);
	cbi(PORTB,5);
	
	pulseT1AStop();
	pulseT1BStop();
	pulseT1Off();
	return 0;
}

